<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>K3s Production Cluster with Calico Full Documentation | Antonio Janach</title>
<meta name=keywords content><meta name=description content="K3s Production Cluster with Calico Full Documentation Infrastructure Specifications This section encompasses all the detailed specifications of Kubernetes virtual machines, load balancer virtual machines, and databases for services/applications. It provides a clear overview of the hardware configurations and networking details for each component in infrastructure setup.
Kubernetes virtual machines specifications: VM CPUs Memory NICs Disks Primary IP Address Network #1 Disk [GB] Access NFS prod-cp-01 2 4096 1 1 192.168.1.10 Bridge 30 SSH key Mounted prod-cp-02 2 4096 1 1 192."><meta name=author content><link rel=canonical href=https://janach.cloud/docs/ha-k3s-cluster/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://janach.cloud/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://janach.cloud/images/cloud-computing.png><link rel=icon type=image/png sizes=32x32 href=https://janach.cloud/favicon-32x32.png><link rel=apple-touch-icon href=https://janach.cloud/apple-touch-icon.png><link rel=mask-icon href=https://janach.cloud/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://janach.cloud/docs/ha-k3s-cluster/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="K3s Production Cluster with Calico Full Documentation"><meta property="og:description" content="K3s Production Cluster with Calico Full Documentation Infrastructure Specifications This section encompasses all the detailed specifications of Kubernetes virtual machines, load balancer virtual machines, and databases for services/applications. It provides a clear overview of the hardware configurations and networking details for each component in infrastructure setup.
Kubernetes virtual machines specifications: VM CPUs Memory NICs Disks Primary IP Address Network #1 Disk [GB] Access NFS prod-cp-01 2 4096 1 1 192.168.1.10 Bridge 30 SSH key Mounted prod-cp-02 2 4096 1 1 192."><meta property="og:type" content="article"><meta property="og:url" content="https://janach.cloud/docs/ha-k3s-cluster/"><meta property="article:section" content="docs"><meta name=twitter:card content="summary"><meta name=twitter:title content="K3s Production Cluster with Calico Full Documentation"><meta name=twitter:description content="K3s Production Cluster with Calico Full Documentation Infrastructure Specifications This section encompasses all the detailed specifications of Kubernetes virtual machines, load balancer virtual machines, and databases for services/applications. It provides a clear overview of the hardware configurations and networking details for each component in infrastructure setup.
Kubernetes virtual machines specifications: VM CPUs Memory NICs Disks Primary IP Address Network #1 Disk [GB] Access NFS prod-cp-01 2 4096 1 1 192.168.1.10 Bridge 30 SSH key Mounted prod-cp-02 2 4096 1 1 192."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Docs","item":"https://janach.cloud/docs/"},{"@type":"ListItem","position":2,"name":"K3s Production Cluster with Calico Full Documentation","item":"https://janach.cloud/docs/ha-k3s-cluster/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"K3s Production Cluster with Calico Full Documentation","name":"K3s Production Cluster with Calico Full Documentation","description":"K3s Production Cluster with Calico Full Documentation Infrastructure Specifications This section encompasses all the detailed specifications of Kubernetes virtual machines, load balancer virtual machines, and databases for services/applications. It provides a clear overview of the hardware configurations and networking details for each component in infrastructure setup.\nKubernetes virtual machines specifications: VM CPUs Memory NICs Disks Primary IP Address Network #1 Disk [GB] Access NFS prod-cp-01 2 4096 1 1 192.168.1.10 Bridge 30 SSH key Mounted prod-cp-02 2 4096 1 1 192.","keywords":[],"articleBody":"K3s Production Cluster with Calico Full Documentation Infrastructure Specifications This section encompasses all the detailed specifications of Kubernetes virtual machines, load balancer virtual machines, and databases for services/applications. It provides a clear overview of the hardware configurations and networking details for each component in infrastructure setup.\nKubernetes virtual machines specifications: VM CPUs Memory NICs Disks Primary IP Address Network #1 Disk [GB] Access NFS prod-cp-01 2 4096 1 1 192.168.1.10 Bridge 30 SSH key Mounted prod-cp-02 2 4096 1 1 192.168.1.11 Bridge 30 SSH key Mounted prod-cp-03 2 4096 1 1 192.168.1.12 Bridge 30 SSH key Mounted prod-wn-01 4 8192 1 1 192.168.1.13 Bridge 50 SSH key Mounted prod-wn-02 4 8192 1 1 192.168.1.14 Bridge 50 SSH key Mounted prod-wn-03 4 8192 1 1 192.168.1.15 Bridge 50 SSH key Mounted Load balancer virtual machines specifications: Load Balancer CPUs Memory NICs Disks Primary IP Address Network #1 Disk [GB] Access NFS prod-internal-lb 2 4096 1 1 192.168.1.20 Bridge 100 SSH key / prod-external-lb 4 8192 1 1 192.168.1.21 Bridge 100 SSH key / Databases specifications for services: VM CPUs Memory NICs Disks Primary IP Address Network #1 Disk [GB] Access NFS Replication psql1 8 16384 1 2 192.168.1.30 Bridge 100 Password-based authentication / Yes psql2 8 16384 1 2 192.168.1.31 Bridge 100 Password-based authentication / Yes Service publishing: Services Publishing External Traffic External Port TLS Termination Internal Traffic LB Pool prod-external-lb By Domain 443 On prod-external-lb 192.168.1.21 192.168.1.10, 192.168.1.11, 192.168.1.12 , 192.168.1.13, 192.168.1.14, 192.168.1.15 prod-external-lb By Domain 6443 On prod-external-lb 192.168.1.21 192.168.1.10, 192.168.1.11, 192.168.1.12 , 192.168.1.13, 192.168.1.14, 192.168.1.15 ðŸ’¡ Control plane nodes IP addresses donâ€™t need to be in LB pool.\nControl Plane Setup This section outlines the setup details for the control plane nodes, highlighting the integrated etcd K3s database configuration in HA mode.\nSetting Up K3s Cluster on prod-cp-01 Execute the following bash command:\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=\"--write-kubeconfig-mode 644 --flannel-backend=none --disable-network-policy --disable traefik --cluster-init\" sh -s - server --node-taint CriticalAddonsOnly=true:NoExecute --tls-san 192.168.1.20 ðŸ’¡ When executing the command above, please check if the node taint is applied. If not, execute the following command:\nkubectl taint nodes prod-cp-01 CriticalAddonsOnly=true:NoExecute Setting Up K3s Cluster on prod-cp-02 \u0026 prod-cp-03 For setting up the K3s cluster on the other nodes, execute the following bash command:\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=\"--write-kubeconfig-mode 644 --flannel-backend=none --disable-network-policy --disable traefik --server https://1192.168.1.10:6443 --token \" sh -s - server --node-taint CriticalAddonsOnly=true:NoExecute --tls-san 10.231.6.62 ðŸ’¡ Retrieve the node token with:\nsudo cat /var/lib/rancher/k3s/server/node-token Worker Nodes Setup Setting Up K3s Worker Nodes For setting up K3s worker nodes, use the following command:\ncurl -sfL https://get.k3s.io | K3S_URL=https://192.168.1.10:6443 K3S_TOKEN= sh - Installing Calico Execute the following command to install the Calico operator and custom resource definitions:\nkubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/tigera-operator.yaml ðŸ’¡ Due to the large size of the CRD bundle, kubectl apply might exceed request limits. Therefore, it is recommended to use kubectl create or kubectl replace.\nCreate the necessary custom resource by executing the following command:\nkubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/custom-resources.yaml ðŸ’¡ Before creating this manifest, read its contents and make sure its settings are correct for your environment. For example, you may need to change the default IP pool CIDR to match your pod network CIDR.\nCluster $ kubectl get nodes -o wide NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME prod-cp-01 Ready control-plane,etcd,master 24h v1.29.4+k3s1 192.168.1.10 Ubuntu 22.04.4 LTS 5.15.0-107-generic containerd://1.7.15-k3s1 prod-cp-02 Ready control-plane,etcd,master 24h v1.29.4+k3s1 192.168.1.11 Ubuntu 22.04.4 LTS 5.15.0-107-generic containerd://1.7.15-k3s1 prod-cp-03 Ready control-plane,etcd,master 24h v1.29.4+k3s1 192.168.1.12 Ubuntu 22.04.4 LTS 5.15.0-107-generic containerd://1.7.15-k3s1 prod-wn-01 Ready 24h v1.29.4+k3s1 192.168.1.13 Ubuntu 22.04.4 LTS 5.15.0-107-generic containerd://1.7.15-k3s1 prod-wn-02 Ready 24h v1.29.4+k3s1 192.168.1.14 Ubuntu 22.04.4 LTS 5.15.0-107-generic containerd://1.7.15-k3s1 prod-wn-03 Ready 24h v1.29.4+k3s1 192.168.1.15 Ubuntu 22.04.4 LTS 5.15.0-107-generic containerd://1.7.15-k3s1 Installing Ingress Nginx Controller The following YAML manifest can be copied and pasted from this URL into a file called ingress-controller.yaml:\napiVersion: v1 kind: Service metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.10.1 name: ingress-nginx-controller namespace: ingress-nginx spec: ipFamilies: - IPv4 ipFamilyPolicy: SingleStack ports: - appProtocol: http name: http port: 80 protocol: TCP targetPort: http nodePort: 32101 - appProtocol: https name: https port: 443 protocol: TCP targetPort: https nodePort: 32102 selector: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx type: LoadBalancer We can test Ingress Nginx by referencing the screenshot below (404 means Ingress Nginx is working):\ncurl 10.231.6.62 Expected output:\n404 Not Found 404 Not Found nginx ","wordCount":"728","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://janach.cloud/docs/ha-k3s-cluster/"},"publisher":{"@type":"Organization","name":"Antonio Janach","logo":{"@type":"ImageObject","url":"https://janach.cloud/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://janach.cloud/ accesskey=h title="Antonio Janach (Alt + H)">Antonio Janach</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://janach.cloud/ title=Home><span>Home</span></a></li><li><a href=https://janach.cloud/about/ title="About Me"><span>About Me</span></a></li><li><a href=https://janach.cloud/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://janach.cloud/docs/ title=Docs><span>Docs</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://janach.cloud/>Home</a>&nbsp;Â»&nbsp;<a href=https://janach.cloud/docs/>Docs</a></div><h1 class=post-title>K3s Production Cluster with Calico Full Documentation</h1><div class=post-meta></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#k3s-production-cluster-with-calico-full-documentation aria-label="K3s Production Cluster with Calico Full Documentation">K3s Production Cluster with Calico Full Documentation</a><ul><li><a href=#infrastructure-specifications aria-label="Infrastructure Specifications">Infrastructure Specifications</a><ul><li><a href=#kubernetes-virtual-machines-specifications aria-label="Kubernetes virtual machines specifications:">Kubernetes virtual machines specifications:</a></li><li><a href=#load-balancer-virtual-machines-specifications aria-label="Load balancer virtual machines specifications:">Load balancer virtual machines specifications:</a></li><li><a href=#databases-specifications-for-services aria-label="Databases specifications for services:">Databases specifications for services:</a></li><li><a href=#service-publishing aria-label="Service publishing:">Service publishing:</a></li></ul></li><li><a href=#control-plane-setup aria-label="Control Plane Setup">Control Plane Setup</a><ul><li><a href=#setting-up-k3s-cluster-on-prod-cp-01 aria-label="Setting Up K3s Cluster on prod-cp-01">Setting Up K3s Cluster on prod-cp-01</a></li><li><a href=#setting-up-k3s-cluster-on-prod-cp-02--prod-cp-03 aria-label="Setting Up K3s Cluster on prod-cp-02 &amp;amp; prod-cp-03">Setting Up K3s Cluster on prod-cp-02 & prod-cp-03</a></li></ul></li><li><a href=#worker-nodes-setup aria-label="Worker Nodes Setup">Worker Nodes Setup</a><ul><li><a href=#setting-up-k3s-worker-nodes aria-label="Setting Up K3s Worker Nodes">Setting Up K3s Worker Nodes</a></li></ul></li><li><a href=#installing-calico aria-label="Installing Calico">Installing Calico</a></li></ul></li><li><a href=#cluster aria-label=Cluster>Cluster</a><ul><li><a href=#installing-ingress-nginx-controller aria-label="Installing Ingress Nginx Controller">Installing Ingress Nginx Controller</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=k3s-production-cluster-with-calico-full-documentation>K3s Production Cluster with Calico Full Documentation<a hidden class=anchor aria-hidden=true href=#k3s-production-cluster-with-calico-full-documentation>#</a></h1><h2 id=infrastructure-specifications>Infrastructure Specifications<a hidden class=anchor aria-hidden=true href=#infrastructure-specifications>#</a></h2><p>This section encompasses all the detailed specifications of Kubernetes virtual machines, load balancer virtual machines, and databases for services/applications. It provides a clear overview of the hardware configurations and networking details for each component in infrastructure setup.</p><h3 id=kubernetes-virtual-machines-specifications>Kubernetes virtual machines specifications:<a hidden class=anchor aria-hidden=true href=#kubernetes-virtual-machines-specifications>#</a></h3><table><thead><tr><th>VM</th><th>CPUs</th><th>Memory</th><th>NICs</th><th>Disks</th><th>Primary IP Address</th><th>Network #1</th><th>Disk [GB]</th><th>Access</th><th>NFS</th></tr></thead><tbody><tr><td>prod-cp-01</td><td>2</td><td>4096</td><td>1</td><td>1</td><td>192.168.1.10</td><td>Bridge</td><td>30</td><td>SSH key</td><td>Mounted</td></tr><tr><td>prod-cp-02</td><td>2</td><td>4096</td><td>1</td><td>1</td><td>192.168.1.11</td><td>Bridge</td><td>30</td><td>SSH key</td><td>Mounted</td></tr><tr><td>prod-cp-03</td><td>2</td><td>4096</td><td>1</td><td>1</td><td>192.168.1.12</td><td>Bridge</td><td>30</td><td>SSH key</td><td>Mounted</td></tr><tr><td>prod-wn-01</td><td>4</td><td>8192</td><td>1</td><td>1</td><td>192.168.1.13</td><td>Bridge</td><td>50</td><td>SSH key</td><td>Mounted</td></tr><tr><td>prod-wn-02</td><td>4</td><td>8192</td><td>1</td><td>1</td><td>192.168.1.14</td><td>Bridge</td><td>50</td><td>SSH key</td><td>Mounted</td></tr><tr><td>prod-wn-03</td><td>4</td><td>8192</td><td>1</td><td>1</td><td>192.168.1.15</td><td>Bridge</td><td>50</td><td>SSH key</td><td>Mounted</td></tr></tbody></table><h3 id=load-balancer-virtual-machines-specifications>Load balancer virtual machines specifications:<a hidden class=anchor aria-hidden=true href=#load-balancer-virtual-machines-specifications>#</a></h3><table><thead><tr><th>Load Balancer</th><th>CPUs</th><th>Memory</th><th>NICs</th><th>Disks</th><th>Primary IP Address</th><th>Network #1</th><th>Disk [GB]</th><th>Access</th><th>NFS</th></tr></thead><tbody><tr><td>prod-internal-lb</td><td>2</td><td>4096</td><td>1</td><td>1</td><td>192.168.1.20</td><td>Bridge</td><td>100</td><td>SSH key</td><td>/</td></tr><tr><td>prod-external-lb</td><td>4</td><td>8192</td><td>1</td><td>1</td><td>192.168.1.21</td><td>Bridge</td><td>100</td><td>SSH key</td><td>/</td></tr></tbody></table><h3 id=databases-specifications-for-services>Databases specifications for services:<a hidden class=anchor aria-hidden=true href=#databases-specifications-for-services>#</a></h3><table><thead><tr><th>VM</th><th>CPUs</th><th>Memory</th><th>NICs</th><th>Disks</th><th>Primary IP Address</th><th>Network #1</th><th>Disk [GB]</th><th>Access</th><th>NFS</th><th>Replication</th></tr></thead><tbody><tr><td>psql1</td><td>8</td><td>16384</td><td>1</td><td>2</td><td>192.168.1.30</td><td>Bridge</td><td>100</td><td>Password-based authentication</td><td>/</td><td>Yes</td></tr><tr><td>psql2</td><td>8</td><td>16384</td><td>1</td><td>2</td><td>192.168.1.31</td><td>Bridge</td><td>100</td><td>Password-based authentication</td><td>/</td><td>Yes</td></tr></tbody></table><h3 id=service-publishing>Service publishing:<a hidden class=anchor aria-hidden=true href=#service-publishing>#</a></h3><table><thead><tr><th>Services Publishing</th><th>External Traffic</th><th>External Port</th><th>TLS Termination</th><th>Internal Traffic</th><th>LB Pool</th></tr></thead><tbody><tr><td>prod-external-lb</td><td>By Domain</td><td>443</td><td>On prod-external-lb</td><td>192.168.1.21</td><td>192.168.1.10, 192.168.1.11, 192.168.1.12 , 192.168.1.13, 192.168.1.14, 192.168.1.15</td></tr><tr><td>prod-external-lb</td><td>By Domain</td><td>6443</td><td>On prod-external-lb</td><td>192.168.1.21</td><td>192.168.1.10, 192.168.1.11, 192.168.1.12 , 192.168.1.13, 192.168.1.14, 192.168.1.15</td></tr></tbody></table><p>ðŸ’¡ Control plane nodes IP addresses don&rsquo;t need to be in LB pool.</p><h2 id=control-plane-setup>Control Plane Setup<a hidden class=anchor aria-hidden=true href=#control-plane-setup>#</a></h2><p>This section outlines the setup details for the control plane nodes, highlighting the integrated etcd K3s database configuration in HA mode.</p><h3 id=setting-up-k3s-cluster-on-prod-cp-01>Setting Up K3s Cluster on prod-cp-01<a hidden class=anchor aria-hidden=true href=#setting-up-k3s-cluster-on-prod-cp-01>#</a></h3><p>Execute the following bash command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;--write-kubeconfig-mode 644 --flannel-backend=none --disable-network-policy --disable traefik --cluster-init&#34;</span> sh -s - server --node-taint CriticalAddonsOnly<span style=color:#f92672>=</span>true:NoExecute --tls-san 192.168.1.20
</span></span></code></pre></div><p>ðŸ’¡ When executing the command above, please check if the node taint is applied. If not, execute the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl taint nodes prod-cp-01 CriticalAddonsOnly<span style=color:#f92672>=</span>true:NoExecute
</span></span></code></pre></div><h3 id=setting-up-k3s-cluster-on-prod-cp-02--prod-cp-03>Setting Up K3s Cluster on prod-cp-02 & prod-cp-03<a hidden class=anchor aria-hidden=true href=#setting-up-k3s-cluster-on-prod-cp-02--prod-cp-03>#</a></h3><p>For setting up the K3s cluster on the other nodes, execute the following bash command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;--write-kubeconfig-mode 644 --flannel-backend=none --disable-network-policy --disable traefik --server https://1192.168.1.10:6443 --token &lt;TOKEN&gt;&#34;</span> sh -s - server --node-taint CriticalAddonsOnly<span style=color:#f92672>=</span>true:NoExecute --tls-san 10.231.6.62
</span></span></code></pre></div><p>ðŸ’¡ Retrieve the node token with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cat /var/lib/rancher/k3s/server/node-token
</span></span></code></pre></div><h2 id=worker-nodes-setup>Worker Nodes Setup<a hidden class=anchor aria-hidden=true href=#worker-nodes-setup>#</a></h2><h3 id=setting-up-k3s-worker-nodes>Setting Up K3s Worker Nodes<a hidden class=anchor aria-hidden=true href=#setting-up-k3s-worker-nodes>#</a></h3><p>For setting up K3s worker nodes, use the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -sfL https://get.k3s.io | K3S_URL<span style=color:#f92672>=</span>https://192.168.1.10:6443 K3S_TOKEN<span style=color:#f92672>=</span>&lt;TOKEN&gt; sh -
</span></span></code></pre></div><h2 id=installing-calico>Installing Calico<a hidden class=anchor aria-hidden=true href=#installing-calico>#</a></h2><p>Execute the following command to install the Calico operator and custom resource definitions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/tigera-operator.yaml
</span></span></code></pre></div><p>ðŸ’¡ Due to the large size of the CRD bundle, <code>kubectl apply</code> might exceed request limits. Therefore, it is recommended to use <code>kubectl create</code> or <code>kubectl replace</code>.</p><p>Create the necessary custom resource by executing the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/custom-resources.yaml
</span></span></code></pre></div><p>ðŸ’¡ Before creating this manifest, read its contents and make sure its settings are correct for your environment. For example, you may need to change the default IP pool CIDR to match your pod network CIDR.</p><h1 id=cluster>Cluster<a hidden class=anchor aria-hidden=true href=#cluster>#</a></h1><pre tabindex=0><code>$ kubectl get nodes -o wide
 
NAME             STATUS   ROLES                       AGE   VERSION        INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION       CONTAINER-RUNTIME
prod-cp-01   Ready    control-plane,etcd,master   24h   v1.29.4+k3s1   192.168.1.10   &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-107-generic   containerd://1.7.15-k3s1
prod-cp-02   Ready    control-plane,etcd,master   24h   v1.29.4+k3s1   192.168.1.11   &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-107-generic   containerd://1.7.15-k3s1
prod-cp-03   Ready    control-plane,etcd,master   24h   v1.29.4+k3s1   192.168.1.12   &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-107-generic   containerd://1.7.15-k3s1
prod-wn-01   Ready    &lt;none&gt;                      24h   v1.29.4+k3s1   192.168.1.13   &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-107-generic   containerd://1.7.15-k3s1
prod-wn-02   Ready    &lt;none&gt;                      24h   v1.29.4+k3s1   192.168.1.14   &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-107-generic   containerd://1.7.15-k3s1
prod-wn-03   Ready    &lt;none&gt;                      24h   v1.29.4+k3s1   192.168.1.15   &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-107-generic   containerd://1.7.15-k3s1
</code></pre><h2 id=installing-ingress-nginx-controller>Installing Ingress Nginx Controller<a hidden class=anchor aria-hidden=true href=#installing-ingress-nginx-controller>#</a></h2><p>The following YAML manifest can be copied and pasted from this URL into a file called <code>ingress-controller.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/component</span>: <span style=color:#ae81ff>controller</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/instance</span>: <span style=color:#ae81ff>ingress-nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>ingress-nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/part-of</span>: <span style=color:#ae81ff>ingress-nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/version</span>: <span style=color:#ae81ff>1.10.1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ingress-nginx-controller</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>ingress-nginx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ipFamilies</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>IPv4</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ipFamilyPolicy</span>: <span style=color:#ae81ff>SingleStack</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>appProtocol</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>32101</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>appProtocol</span>: <span style=color:#ae81ff>https</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>https</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>https</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>32102</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/component</span>: <span style=color:#ae81ff>controller</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/instance</span>: <span style=color:#ae81ff>ingress-nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>ingress-nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>LoadBalancer</span>
</span></span></code></pre></div><p>We can test Ingress Nginx by referencing the screenshot below (404 means Ingress Nginx is working):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl 10.231.6.62
</span></span></code></pre></div><p>Expected output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://janach.cloud/>Antonio Janach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>